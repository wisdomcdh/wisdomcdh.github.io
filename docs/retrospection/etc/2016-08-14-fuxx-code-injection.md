---
title: 2016 일본 카드사고 수습후기
---
# 2016 카드사고 수습후기

2016년도 일본에서 카드 유출 사고가 있었고, 이걸 수습했던 기록이다.

## 1. 2016년 7월 일본에서 카드 사고 터지다 

2016년 7월 일본의 PG 중 하나인 Paygent를 이용하는 기업 중 일부 기업들에게 카드사고 보안 경고가 내려졌다. 
이미 4월에 다른 업체에서 사고가 있어서 비슷한 보안점검 안내 메일이라 생각했다. 

우리가 운영하는 서버는 내부 방에서만 접속이 가능했고, 웹사이트는 WebKnight와 같은 방화벽으로 기본적인 방비를 해둔 상태였다.

그래서 이번에도 또 다른 일본 업체가 털렸구나 라고 생각하고 있었다. 

> ㅋㅋㅋ 불구경 꿀잼 
> 하지만, 사실 우리 집이 불타고 있었다. ㅜㅜ 

이번 경고 메일은 내용부터 달랐다. 
내용은 즉슨, 1만 4천 명 정도의 카드사고가 발생하였는데, 우리는 이들 카드번호로 구매 이력이 있는 몇 안되는 기업 중 하나라는 것이다. 
그리고 사고를 수습하고 카드결제를 지속하고 싶으면 설문조사와 포렌식 검사를 받으라는 것이었다. 

처음에는 우리는 카드 번호를 저장하지 않는데 무슨 소리인가 했다. 
아무튼 상황은 웃어넘길 수 없는 상황이라 적극 응대할 수밖에 없었다.

### 카드가 털리면 어떻게 되는가?

카드번호와 유효기간 cvc를 탈취당하게 되면, 해커는 순진하게 ATM기에 가서 출금 같은걸 하지 않는다. 보통 현금화가 가능한 상품(쌀, 구리, 철, 부품)을 대량으로 구매해 해외로 빼돌려 현금화한다. 
대부분 중국배를 타고 나가는데 이러면 못 잡는다고 보면 된다. 

이번 사고를 낸 범인들은 쌀을 샀다. 

> 일본은 FDS가 제대로 동작하는지 궁금했다. 
> 평소에 종이만 사는 고객이 갑자기 대량의 쌀을 사면 의심부터 되지 않나?

## 2. 설문조사에 임하다.

먼저 PG사로부터 보안 설문조사가 왔는데 대충 이런 내용이다. 

1. 카드정보를 저장하고 있는가? 
2. 카드정보 저장 서비스를 위해 저장한 카드 정보가 모든 정보를 포함하고 있는가? 
3. 고객정보 (이름, 이메일, 연락처)를 저장하고 있는가? 
4. 적절한 보호수단으로 보호되고 있는가? 
5. 서버에 원격 침입을 막기 위한 방화벽이 설치되어 있는가? 

대략, 이런 질문들이 있었고 성실히 답변하였다. 

## 3. 변호사 자문을 받다

사실 설문조사는 어차피 의미 없다 여기에 엮인 모든 기업이 다들 문제없다고 할 것이기 때문이다. 그것보다 빨리 우리 쪽에 문제가 없다는 걸 증명해야 한다. 

이 문제에 대해 일본 변호사와 어떻게 해결하면 좋은지 상담을 했었는데, 일본의 경제산업성이 관련되기 때문에 먼저 성실히 조사에 임해야 하는 게 중요하다는 조언을 들었다. 그리고 논쟁에 의해 문제가 해결되지 않고 지속되면, 처리비용만 증가하고 카드결제 또한 막힐 수 있기 때문에라도 성실히 임해야 한다고 들었다.

> 카드사고의 경우 재빠르게 귀책사유가 없음을 증명하거나, 문제가 있을 경우 빠르게 보안 처리하지 않으면 카드결제를 할 수 없게 된다. 
> 만약 카드사에서 계약 거부까지 가게 되면 법인을 새로 만들지 않는 이상 영영 카드결제는 하지 못한다. PG를 뭘 사용하던 말이다. 이건 쇼핑몰 플랫폼 기업에겐 치명적이다.

귀책사유를 증명하는 것도 좋지만, 문제를 빠르게 해결하는 방법도 생각해야 한다.

## 4. 포렌식 검사
일본의 포렌식 업체와 연락을 취했다. 
업체에서 우리 측 서버에 원격으로 접속할 수 있도록 요청이 있었고, 해당 업체의 IP를 방화벽에서 해제하고 접근할 수 있도록 추가 계정을 내어줬다. 

이후에 포렌식 업체에선 문제를 찾지 못했다고 연락이 왔다. 

> 얘는 뭘 했는지 모르겠다. 로그만 대충 보고 윈도 방화벽 검사나 정책 검사만 했다. 
> 우리가 거지 같았던 건 맞는데 그런 걸 다 열어놓겠냐... 

검사가 끝나면, 보고서를 받게 된다. 
이 보고서에는 이후 우리가 알려준 단 한 가지 문제점이 추가되게 된다.


### 자체 보안검사

포렌식 업체의 점검과 다르게 우리는 나름의 보안검사를 따로 진행하기로 했다. 

곧, code injection 공격이 가능한 1가지 루트가 발견했다. 
문제가 된 사이트는 admin 사이트였는데, 이 사이트는 코드에 신경을 안 썼던 구형 사이트라 보안에 취약했다. 

1. 사용하지 않는 업로드 핸들러가 존재했고, 여기에 아무런 필터가 없다. 
2. 이 핸들러가 사용하는 디렉터리에서 스크립트 동작이 가능하도록 설정되어 있다. 

외부에 노출되지 않는 사이트였지만, 운영 사이트의 콘텐츠 주소가 이 주소를 가리키고 있어 사실 프라이빗하지 않았던 사이트이다.

###### 자체 공격 테스트

![attack2](/assets/images/etc/attack2.png)
![attack](/assets/images/etc/attack.png)

공격코드를 직접 작성하여 실행해 보았다. 
우리가 가진 방화벽에서 여려 명령어들을 필터링해주긴 했는데 BASE64로 인코딩하여 디코딩 후 실행하게 하니 black list 따윈 그냥 뚫렸다. 
code injection 공격은 가능한 걸로 증명됐다.

###### 공격 로그 분석

취약점이 있다고 해서 반드시 공격을 받은 건 아니다. 그래서 공격의 흔적이 있는지 찾아보기로 했다.

![attack3](/assets/images/etc/attack3.png)

발견..

> 이걸 포렌식 업체에선 발견 못했다...

분석결과 다음의 정황을 찾았다.

1. 7월 30일 처음 코드 인젝션을 시도했다.
2. 공격자는 어디선가 -> 174.3.71.99 캐나다 -> 125.141.224.183 한국을 통해 들어왔다.
3. 관리자 사이트를 통해 파일을 업로드하고 무언가 실행시키다 실패했다.
4. php코드만을 만들었을 뿐, 이 것을 실행하거나 다른 스크립트 파일을 생성하거나 삭제한 흔적은 없다.

정황상 공격을 완수하지 못해 탈취 가능한 정보는 없다고 결론을 내었다.

## 4. 치명적 실수

이런 일을 처음 겪다 보니 멍청하게도 물어보지도 않았는데 code injection 공격에 취약점이 있어서 조치했다고 PG사에게만 알렸다. 
그런데 이 씹세들은 카드사에 이야기하고 php와 같은 스크립트 파일이 올라갈 수 있는 것 자체가 문제라고 포렌식 검사비용과 사고 카드 재발급 금액을 지급해야 한다고 답변했다. 

거절하면 변호사 이야기대로 해결될 때까지 카드결제가 중단되니 회사에선 우리 고객도 아닌 사람들의 카드까지 재발급 비용을 지불할 수밖에 없었다.

## 5. 후속처리

카드사고는, 일본 경제산업성에 경과를 보고 해야만 한다. 
다음 내용을 보강하고 알렸다. 

1. 고객과 admin의 업로드 파일은 모두 격리된 공간으로 업로드되도록 변경 
2. 업로드 핸들러를 단일 서비스로 변경하여 보안 관리 집중화 
3. 격리된 공간의 스크립트 실행 권한 제거 
4. 카드결제 방식을 비통과형(PG사 링크)으로 수정 
5. 추가 방화벽 도입 
6. 이상파일 삭제 시스템 개발 (서버에 허용되지 않는 파일이 업로드되면 그 즉시 삭제되는 윈도 서비스 개발) 
7. 카드 재발급비용 부담 등등..

다소 억울한 점은 있었지만, 나는 요구하는 보안 처리를 거의 하루 조치하는 형식으로 빠르게 응대했고 결제수단이 막히는 것까지 가지 않고 사건을 수습할 수 있게 되었다.

## 6. 후기

이상하게 매출은 더 늘었다. 
그동안 사건이 없었던 탓일까 일본 메이저 신문과 방송사에 회사 이름이 대문짝만 하게 걸렸다. 
일본 기사에는 위의 후속처리 내용도 같이 실렸는데 이 것 자체가 바이럴 마케팅이 된 건지 뭔지 몰라도 매출은 급성장했다.

![glory](/assets/images/etc/glory.png)
![glory2](/assets/images/etc/glory2.png)

> 엄마 나 티비 나왔어 ㅠㅠ

## 7. 반성

사실 이렇게 웃고 넘길일이 아니다.
이커머스가 이런 일이 발생하면 욕을 많이 먹어야만 하는데 이유는 다음과 같다.

큰 기업이던 작은 기업이던 규모에 상관없이 보안사고가 발생하는데, 경험상 대부분은 해커의 실력이 너무나 뛰어나서 발생하는 게 아니다. 이런 보안사고는 기업이 그만큼 보안에 무관심하기 때문에 발생한다. 

우리는 경악스럽게도 과거 고객 패스워드가 평문으로 저장되어 있었는데, 
내가 이것을 암호화해야 하기 때문에 다른 개발은 잠시 기다려야 한다고 했을 때, 모 임원은 돈도 안되는걸 왜 하냐고 그랬다.

> 나: 고객 개인정보 중에 우리가 알아서는 안되는 정보이니까요!
> 그: 안보면 되잖아?! 회사가 오늘 내일인데 그걸 왜해!

그만큼 대부분 무지하고 무관심하다.

회사가 왜 욕을 더 먹어야 하냐면, 보통 카드 결제는 PG사에서도 당시의 유행하는 카드유출 방법을 미리 리포팅해주고 사고에 대미하라고 수차례 이야기 해준다.
그리고 사건이 터지기 전엔 서버측 로그에 그런 징후들이 발생하기 시작한다.

대응할 수 있는 시간은 길게는 몇달 짧으면 하루 정도 생기기 마련인데 이 때도 낙관적으로 아무것도 하지 않는게 이런 사고에 노출되는 회사의 행태이다.

내가 몸듬은 조직도 그랬다.
나중에 일정 잡자고 미루지 않고, 자체적으로 이슈를 만들어 검사를 했으면 이런 일은 생기지도 않았을 것이다.

개인의 무관심에서 시작하고 조직이 결정타를 날리게 된다.